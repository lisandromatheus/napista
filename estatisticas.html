<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Na Pista - Analytics Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .fade-in { animation: fadeIn 0.8s cubic-bezier(0.22, 1, 0.36, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        body { background-color: #0f172a; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        
        .glass-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.7), rgba(15, 23, 42, 0.9));
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }
        
        .profile-badge {
            background: linear-gradient(90deg, #ec4899, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="min-h-screen relative pb-10 bg-gray-900 selection:bg-pink-500 selection:text-white">

    <div class="max-w-md mx-auto min-h-screen bg-gray-900 shadow-2xl relative fade-in">
        
        <div class="bg-gray-800 p-5 rounded-b-3xl shadow-lg border-b border-gray-700 sticky top-0 z-30 flex items-center justify-between">
            <a href="index.html" class="text-gray-400 hover:text-white transition p-2"><i class="fa-solid fa-arrow-left text-xl"></i></a>
            <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                <i class="fa-solid fa-chart-line mr-2 text-purple-500"></i>Analytics Pro
            </h1>
            <div class="w-8"></div>
        </div>

        <div class="p-5 pb-2">
            <p class="text-center text-[10px] text-gray-500 uppercase tracking-widest mb-3">Identidade baseada em dados reais</p>
            
            <div id="share-card" class="glass-card rounded-3xl p-6 relative overflow-hidden group">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-purple-600 rounded-full blur-[60px] opacity-20 animate-pulse"></div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-pink-600 rounded-full blur-[60px] opacity-20 animate-pulse"></div>
                
                <div class="flex items-center justify-between mb-6 relative z-10">
                    <div class="flex items-center">
                        <img id="card-photo" src="" class="w-14 h-14 rounded-full border-2 border-white/20 shadow-lg object-cover">
                        <div class="ml-3">
                            <h3 id="card-name" class="font-bold text-white text-xl leading-none drop-shadow-md">Usuario</h3>
                            <span class="text-[9px] text-pink-300 uppercase tracking-wider font-bold" id="card-subtitle">Na Pista ¬Æ</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <i class="fa-solid fa-fingerprint text-3xl text-white/10"></i>
                    </div>
                </div>

                <div class="text-center py-4 relative z-10 border-y border-white/10 my-2">
                    <span class="text-[9px] text-gray-400 uppercase tracking-[0.3em]">Perfil Comportamental</span>
                    <h2 id="persona-title" class="text-2xl font-black profile-badge mt-1 mb-2 leading-tight uppercase">CALCULANDO...</h2>
                    <p id="persona-desc" class="text-xs text-gray-300 italic font-light px-1">Integrando dados...</p>
                </div>

                <div class="grid grid-cols-3 gap-2 mt-4 relative z-10 text-center">
                    <div class="bg-gray-900/40 rounded-lg p-2 backdrop-blur-md border border-white/5">
                        <span class="block text-lg font-bold text-white" id="card-total">0</span>
                        <span class="text-[8px] text-gray-400 uppercase tracking-wider">Total Dates</span>
                    </div>
                    <div class="bg-gray-900/40 rounded-lg p-2 backdrop-blur-md border border-white/5">
                        <span class="block text-lg font-bold text-blue-400" id="card-targets">0</span>
                        <span class="text-[8px] text-gray-400 uppercase tracking-wider">Contatos</span>
                    </div>
                    <div class="bg-gray-900/40 rounded-lg p-2 backdrop-blur-md border border-white/5">
                        <span class="block text-lg font-bold text-green-400" id="card-status">?</span>
                        <span class="text-[8px] text-gray-400 uppercase tracking-wider">Modo</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-5 mt-4">
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-purple-500 to-blue-600"></div>
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center">
                    <i class="fa-solid fa-clipboard-check mr-2"></i> Diagn√≥stico
                </h3>
                
                <div class="space-y-4 text-sm text-gray-300">
                    <div class="border-b border-gray-700 pb-3">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Resumo da √ìpera</p>
                        <p id="diag-scenario" class="leading-relaxed font-medium text-white italic">Analisando...</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">√öltima Atividade</p>
                            <p id="diag-last" class="text-xs text-gray-300">--</p>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Tend√™ncia</p>
                            <p id="diag-trend" class="text-xs text-gray-300">--</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-5 space-y-6 mt-6">
            
            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-4 text-center tracking-widest">Share de Aten√ß√£o (Top 5)</h3>
                <div class="relative h-40 w-full flex justify-center">
                    <canvas id="chartAttention"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 shadow-lg">
                <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-2 text-center tracking-widest">Fluxo Financeiro (Agenda)</h3>
                <p id="finance-msg" class="text-[10px] text-center text-pink-500 mb-4 italic font-bold">...</p>
                <div class="relative h-32 w-full flex justify-center">
                    <canvas id="chartFinance"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CHAVES DO BANCO (CR√çTICO: DEVE SER IGUAL AO INDEX) ---
        const KEY_USER = 'napista_user';
        const KEY_CONTACTS = 'napista_contacts';
        const KEY_EVENTS = 'napista_events';

        // Carregamento Seguro
        const user = JSON.parse(localStorage.getItem(KEY_USER));
        const contacts = JSON.parse(localStorage.getItem(KEY_CONTACTS) || "[]");
        const events = JSON.parse(localStorage.getItem(KEY_EVENTS) || "[]");

        // Helpers
        const isFemale = user && (user.genero === 'Feminino');
        const term = (m, f) => isFemale ? f : m;

        window.onload = () => {
            if(!user) { window.location.href = 'index.html'; return; }
            
            document.getElementById('card-name').innerText = user.nome;
            document.getElementById('card-photo').src = user.foto;

            const analysis = runAnalysis();
            renderIdentity(analysis);
            renderCharts(analysis);
        }

        // --- MOTOR DE AN√ÅLISE (O C√âREBRO) ---
        function runAnalysis() {
            // 1. Calcular TOTAL DE ENCONTROS (Soma Manual + Agenda)
            // A prioridade √© o contador manual do contato, pois o usu√°rio pode editar l√°.
            let totalDates = 0;
            contacts.forEach(c => {
                totalDates += (parseInt(c.encontros) || 0);
            });

            // 2. Analisar distribui√ß√£o por parceiro
            // Cria um ranking baseado nos contadores manuais dos contatos
            let ranking = contacts.map(c => ({
                name: c.nome,
                count: parseInt(c.encontros) || 0,
                rating: parseInt(c.rating) || 0,
                active: !c.dataFim // Considera ativo se n√£o tiver data fim
            })).sort((a, b) => b.count - a.count);

            // Filtra quem tem pelo menos 1 encontro para contar "Parceiros Ativos"
            const activePartners = ranking.filter(r => r.count > 0).length;

            // 3. Dados Temporais (Baseado na Agenda/Eventos se houver, sen√£o estimativa)
            let daysSince = 999;
            const completedEvents = events.filter(e => e.status === 'completed');
            
            if (completedEvents.length > 0) {
                // Tem agenda: usa data real
                const lastDateEvt = completedEvents.sort((a, b) => new Date(b.date + 'T' + b.time) - new Date(a.date + 'T' + a.time))[0];
                const diff = new Date() - new Date(lastDateEvt.date + 'T' + lastDateEvt.time);
                daysSince = Math.floor(diff / (1000 * 60 * 60 * 24));
            } else if (totalDates > 0) {
                // N√£o tem agenda, mas tem contatos com n√∫meros: assume "Ativo Indefinido" (0 dias) para n√£o desencorajar
                daysSince = 0; 
            }

            // --- DEFINI√á√ÉO DE PERFIL (20+ VARIA√á√ïES) ---
            let persona = "EM AN√ÅLISE";
            let desc = "Coletando dados...";
            let status = "Neutro";
            let text = "";

            // Top 1 (se existir)
            const top1 = ranking.length > 0 ? ranking[0] : null;
            const top2 = ranking.length > 1 ? ranking[1] : null;

            // L√ìGICA DE DECIS√ÉO
            
            // 1. ZERADO REAL
            if (totalDates === 0) {
                persona = "ESPECTADOR(A)";
                desc = "Assistindo o jogo da arquibancada.";
                status = "Zero";
                text = "Nenhum encontro registrado nos contatos. Adicione um contador manual ou marque na agenda!";
            }
            // 2. MONOGAMIA ABSOLUTA
            else if (activePartners === 1 && totalDates > 3) {
                persona = term("O FIEL", "A FIEL");
                desc = `100% focado(a) em ${top1.name}.`;
                status = "Comprometido";
                text = `Seus n√∫meros n√£o mentem: s√≥ existe <b>${top1.name}</b> na sua vida agora. O app virou di√°rio de casal?`;
            }
            // 3. ALTA RODAGEM (Muitos parceiros)
            else if (activePartners >= 4) {
                persona = term("O MALABARISTA", "A MALABARISTA");
                desc = `${activePartners} pratos girando ao mesmo tempo.`;
                status = "Caos";
                text = "Voc√™ est√° gerenciando m√∫ltiplos contatos com encontros realizados. Haja organiza√ß√£o (e dinheiro)!";
            }
            // 4. D√öVIDA (Empate no topo)
            else if (top1 && top2 && (top1.count === top2.count) && top1.count > 1) {
                persona = "CORA√á√ÉO DIVIDIDO";
                desc = `Empate entre ${top1.name} e ${top2.name}.`;
                status = "D√∫vida";
                text = `Temos um empate t√©cnico no topo do ranking. Voc√™ est√° investindo tempo igual em duas pessoas.`;
            }
            // 5. O REINCIDENTE (Muitos encontros com Ex ou Vencido)
            else if (top1 && !top1.active && top1.count > 5) {
                persona = "O NOST√ÅLGICO";
                desc = "Seus maiores n√∫meros s√£o com quem j√° foi.";
                status = "Apegado";
                text = `Voc√™ saiu muito com <b>${top1.name}</b>, mas o contrato acabou. Hora de focar nos novos leads!`;
            }
            // 6. VOLUME ALTO (Geral)
            else if (totalDates > 15) {
                persona = "LENDA VIVA";
                desc = "Hist√≥rico invej√°vel de atua√ß√£o.";
                status = "Pro";
                text = "Sua quilometragem √© alta. Voc√™ j√° viu de tudo nesse app.";
            }
            // 7. REC√âM CHEGADO
            else if (totalDates <= 3) {
                persona = "AQUECENDO";
                desc = "Primeiros passos na pista.";
                status = "In√≠cio";
                text = "Come√ßando os trabalhos. Aumente esses n√∫meros para desbloquear novas patentes.";
            }
            // 8. PADR√ÉO (Resto)
            else {
                persona = term("JOGADOR CARO", "JOGADORA CARA");
                desc = "Atua√ß√£o consistente e distribu√≠da.";
                status = "Na Pista";
                text = "Voc√™ est√° jogando o jogo corretamente. Nem muito apegado, nem muito solto.";
            }

            return {
                totalDates,
                activePartners,
                ranking,
                completedEvents,
                daysSince,
                persona,
                desc,
                status,
                text
            };
        }

        // --- RENDER ---
        function renderIdentity(data) {
            document.getElementById('persona-title').innerText = data.persona;
            document.getElementById('persona-desc').innerText = data.desc;
            
            document.getElementById('card-total').innerText = data.totalDates;
            document.getElementById('card-targets').innerText = data.activePartners;
            
            const stEl = document.getElementById('card-status');
            stEl.innerText = data.status;
            
            // Cores Status
            if (data.status === 'Comprometido' || data.status === 'Apegado') stEl.classList.add('text-pink-500');
            else if (data.status === 'Caos' || data.status === 'Pro') stEl.classList.add('text-purple-500');
            else if (data.status === 'Zero') stEl.classList.add('text-gray-500');
            else stEl.classList.add('text-green-400');

            // Diagn√≥stico
            document.getElementById('diag-scenario').innerHTML = data.text;
            
            // Datas
            let lastText = "Sem dados";
            let trendText = "N/A";
            
            if (data.totalDates > 0) {
                if (data.daysSince === 0) lastText = "Hoje/Recente (Manual)";
                else if (data.daysSince === 999) lastText = "Indefinido";
                else lastText = `${data.daysSince} dias atr√°s`;
                
                if (data.daysSince < 7) trendText = "üî• Aquecido";
                else if (data.daysSince > 30) trendText = "üßä Esfriando";
                else trendText = "‚öñÔ∏è Est√°vel";
            }
            
            document.getElementById('diag-last').innerText = lastText;
            document.getElementById('diag-trend').innerText = trendText;
        }

        function renderCharts(data) {
            // GR√ÅFICO 1: ATEN√á√ÉO (Pizza) baseada no contador manual
            let labels = [];
            let counts = [];
            
            if (data.ranking.length === 0) {
                labels = ['Vazio']; counts = [1];
            } else {
                // Top 4 + Outros
                data.ranking.slice(0, 4).forEach(r => {
                    if(r.count > 0) {
                        labels.push(r.name.split(' ')[0]);
                        counts.push(r.count);
                    }
                });
                
                // Se sobrou gente com contagem > 0
                const others = data.ranking.slice(4).reduce((sum, r) => sum + r.count, 0);
                if (others > 0) { labels.push('Outros'); counts.push(others); }
            }
            
            // Se tudo for zero (mas tem contatos cadastrados)
            if (counts.length === 0) { labels = ['Sem Encontros']; counts = [1]; }

            new Chart(document.getElementById('chartAttention'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: ['#ec4899', '#8b5cf6', '#3b82f6', '#10b981', '#f59e0b', '#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#9ca3af', font: {size:10}, boxWidth:10 } } }
                }
            });

            // GR√ÅFICO 2: FINANCEIRO (Baseado na Agenda)
            // Esse precisa da agenda pois o contador manual n√£o guarda quem pagou
            let payData = { 'Eu': 0, 'Dividido': 0, 'Ela': 0 };
            data.completedEvents.forEach(e => { if(e.pay) payData[e.pay]++; });
            
            const totalPay = payData['Eu'] + payData['Dividido'] + payData['Ela'];
            const msgEl = document.getElementById('finance-msg');
            
            if (totalPay === 0) {
                msgEl.innerText = "Requer uso da Agenda para calcular.";
            } else {
                if(payData['Eu'] > totalPay/2) msgEl.innerText = "Voc√™ investe pesado.";
                else if(payData['Ela'] > totalPay/2) msgEl.innerText = "Retorno sobre investimento alto.";
                else msgEl.innerText = "Parceria equilibrada.";
            }

            new Chart(document.getElementById('chartFinance'), {
                type: 'bar',
                data: {
                    labels: ['Eu', 'Meio', 'O Date'],
                    datasets: [{
                        label: 'Qtd',
                        data: [payData['Eu'], payData['Dividido'], payData['Ela']],
                        backgroundColor: ['#ef4444', '#3b82f6', '#10b981'],
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#374151' }, ticks: { color: '#9ca3af', font:{size:9} } },
                        x: { grid: { display: false }, ticks: { color: '#9ca3af', font:{size:10} } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>